<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Мои счета</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0 }
        .container {
          max-width: 1200px;
          margin: 20px auto;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          overflow: hidden;
        }
        .navbar { display:flex; justify-content:space-around; background:#fafafa; border-bottom:1px solid #ddd; }
        .navbar a { padding:12px 20px; text-decoration:none; color:#333; font-weight:500; }
        .navbar a.active { color:#007bff; border-bottom:3px solid #007bff; }
        .navbar a:hover { background:#f0f0f0; }
        .content { padding:20px; }
        h1 { margin:0 0 20px; font-size:1.4em; }
        .actions {
          margin-bottom: 15px;
        }
        .actions button {
          padding: 8px 16px;
          margin-right: 10px;
          border: none;
          border-radius: 4px;
          color: #fff;
          cursor: pointer;
        }
        .actions .deposit { background: #28a745; }
        .actions .withdraw { background: #dc3545; }
        .actions a.history {
          margin-left: 20px;
          color: #007bff;
          text-decoration: none;
          font-weight: 500;
        }
        .actions a.history:hover { text-decoration: underline; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:8px 12px; border-bottom:1px solid #ddd; text-align:left; }
        th { background:#f0f0f0; }
        .no-data { text-align:center; color:#777; padding:20px 0; }

        /* Модалка */
        .modal-backdrop {
          position: fixed; top:0; left:0; right:0; bottom:0;
          background: rgba(0,0,0,0.5);
          display: none; align-items: center; justify-content: center;
        }
        .modal {
          background: #fff; padding:20px; border-radius:8px;
          width: 320px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .modal h2 { margin-top:0; }
        .form-group { margin:10px 0; }
        .form-group label { display:block; margin-bottom:4px; font-weight:500; }
        .form-group input {
          width:100%; padding:6px; box-sizing:border-box;
        }
        .modal .actions {
          text-align: right; margin-top: 15px;
        }
        .modal .actions button {
          margin-left: 8px; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;
        }
        .modal .actions .confirm { background: #007bff; color:#fff; }
        .modal .actions .cancel  { background: #6c757d; color:#fff; }
    </style>
</head>
<body>

<div class="container">
    <nav class="navbar">
        <a href="/portfolio.html">Портфель</a>
        <a href="/markets.html">Рынки</a>
        <a href="/accounts.html" class="active">Мои счета</a>
        <a href="/orders.html">Мои заявки</a>
        <a href="/transactions.html">Мои транзакции</a>
    </nav>

    <div class="content">
        <h1>Мои валютные счета</h1>
        <div class="actions">
            <button class="deposit" onclick="openModal('deposit')">Пополнить баланс</button>
            <button class="withdraw" onclick="openModal('withdraw')">Снять баланс</button>
            <a href="/balance_history.html" class="history">История баланса</a>
        </div>

        <table id="accountsTable">
            <thead>
            <tr>
                <th>Код валюты</th>
                <th>Баланс</th>
                <th>Зарезервировано</th>
            </tr>
            </thead>
            <tbody>
            <tr><td colspan="3" class="no-data">загрузка...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно пополнения/снятия -->
<div id="modal" class="modal-backdrop">
    <div class="modal">
        <h2 id="modalTitle">Операция</h2>
        <div class="form-group">
            <label for="currencyInput">Код валюты</label>
            <input type="text" id="currencyInput" placeholder="например, USD">
        </div>
        <div class="form-group">
            <label for="amountInput">Сумма</label>
            <input type="number" id="amountInput" min="0.01" step="0.01">
        </div>
        <div class="actions">
            <button class="cancel" onclick="closeModal()">Отмена</button>
            <button class="confirm" onclick="submitOperation()">Подтвердить</button>
        </div>
    </div>
</div>

<script>
    let currentOp = null; // 'deposit' или 'withdraw'

    async function loadAccounts() {
      const tbody = document.querySelector('#accountsTable tbody');
      try {
        const resp = await fetch('/api/accounts/list');
        if (!resp.ok) throw new Error(resp.status);
        const list = await resp.json();
        tbody.innerHTML = '';
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="no-data">Счета не найдены</td></tr>';
          return;
        }
        for (const acc of list) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${acc.currencyCode}</td>
            <td>${acc.balance.toFixed(2)}</td>
            <td>${acc.reservedAmount.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="3" class="no-data">Ошибка загрузки счетов</td></tr>';
        console.error(err);
      }
    }

    function openModal(op) {
      currentOp = op;
      document.getElementById('modalTitle').textContent =
        op === 'deposit' ? 'Пополнить баланс' : 'Снять баланс';
      document.getElementById('currencyInput').value = '';
      document.getElementById('amountInput').value = '';
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function submitOperation() {
      const currency = document.getElementById('currencyInput').value.trim().toUpperCase();
      const amount   = parseFloat(document.getElementById('amountInput').value);
      if (!currency || isNaN(amount) || amount <= 0) {
        return alert('Укажите корректный код валюты и сумму');
      }
      const url = currentOp === 'deposit'
        ? '/api/accounts/deposit'
        : '/api/accounts/withdraw';
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ currencyCode: currency, amount })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          alert('Ошибка: ' + txt);
        } else {
          closeModal();
          loadAccounts();
        }
      } catch (err) {
        alert('Сетевая ошибка: ' + err.message);
      }
    }

    window.addEventListener('DOMContentLoaded', loadAccounts);
</script>
</body>
</html>
